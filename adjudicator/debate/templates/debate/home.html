{% extends 'base.html' %}

{% block content %}
<div class="home-page">
    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}
    
    <div id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Analyzing debate...</div>
    </div>

    <h1>SquabbleSort</h1>
    <div class="explanation">
        <p><strong>What does it do?</strong></p>
        <p>Give SquabbleSort an argument and it'll:</p>
        <ul>
            <li>Anonymise it and rewrite both sides to remove bias from identity or writing style</li>
            <li>Give you a breakdown of both sides of the argument</li>
            <li>Pick a winner</li>
        </ul>
        <p class="disclaimer">It's unbiased, but sometimes mistaken.</p>
    </div>

    <div class="credit-info">
        <p>Credits Remaining: {{ credits|floatformat:2 }} / 15.00</p>
        <p>Total Credits Used: {{ total_credits_used|floatformat:2 }}</p>
    </div>

    <form method="post" class="analysis-form" onsubmit="showLoading()">
        {% csrf_token %}
        <div class="form-group">
            <label for="debate_text">Enter the debate text:</label>
            <textarea 
                id="debate_text" 
                name="debate_text" 
                rows="10" 
                required
                placeholder="Paste or type the debate text here..."
            >{{ debate_text }}</textarea>
        </div>
        <button type="submit">Analyze Debate</button>
    </form>
</div>

<div id="analysis-results" style="display: none;">
    <div class="participants">
        <div class="participant">
            <h3 id="belligerent-1"></h3>
            <p id="summary-1"></p>
        </div>
        <div class="participant">
            <h3 id="belligerent-2"></h3>
            <p id="summary-2"></p>
        </div>
    </div>
    <div id="evaluation"></div>
    <div id="judgment"></div>
</div>

<style>
    .home-page {
        max-width: 800px;
        margin: 0 auto;
    }

    .intro {
        color: #4b5563;
        font-size: 1.1em;
        margin-bottom: 2rem;
    }

    .analysis-form {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
    }

    textarea:focus {
        outline: none;
        border-color: #2c3e50;
        box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
    }

    button {
        background: #2c3e50;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    button:hover {
        background: #34495e;
    }

    .error-message {
        background: #fee2e2;
        border: 1px solid #ef4444;
        color: #991b1b;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2c3e50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        margin-top: 1rem;
        font-size: 1.2rem;
        color: #2c3e50;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .explanation {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }

    .explanation p {
        margin: 0.5rem 0;
    }

    .explanation ul {
        margin: 0.5rem 0 1rem 1.5rem;
    }

    .explanation li {
        margin: 0.25rem 0;
    }

    .disclaimer {
        font-style: italic;
        color: #6c757d;
        margin-top: 1rem;
    }
</style>

<script>
function showLoading() {
    event.preventDefault();
    
    const credits = parseFloat('{{ credits }}');
    if (credits < 1.0) {
        alert('You have reached your credit limit. Please try again later.');
        return false;
    }
    
    document.getElementById('loading-overlay').style.display = 'flex';
    document.getElementById('analysis-results').style.display = 'block';
    
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    fetch('/analyze-stream/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            return response.json().then(data => {
                console.log('Error response data:', data);
                throw new Error(data.error || 'Network response was not ok');
            });
        }
        const evtSource = new EventSource('/analyze-stream/');
        
        evtSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            switch(data.stage) {
                case 'analyzing':
                case 'evaluating':
                case 'judging':
                    document.querySelector('.loading-text').textContent = data.message;
                    break;
                    
                case 'initial_analysis':
                    document.getElementById('belligerent-1').textContent = data.belligerent_1;
                    document.getElementById('belligerent-2').textContent = data.belligerent_2;
                    document.getElementById('summary-1').textContent = data.summary_1;
                    document.getElementById('summary-2').textContent = data.summary_2;
                    break;
                    
                case 'evaluation':
                    document.getElementById('evaluation').innerHTML = data.evaluation.replace(/\n/g, '<br>');
                    break;
                    
                case 'complete':
                    evtSource.close();
                    window.location.href = data.redirect;
                    break;
                    
                case 'error':
                    evtSource.close();
                    document.querySelector('.loading-text').textContent = 'Error: ' + data.message;
                    break;
            }
        };
    })
    .catch(error => {
        console.error('Caught error:', error);
        document.querySelector('.loading-text').textContent = 'Error: ' + error.message;
        document.getElementById('loading-overlay').style.display = 'none';
    });
    
    return false;
}
</script>
{% endblock %} 